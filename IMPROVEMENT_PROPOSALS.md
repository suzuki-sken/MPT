# streamlit_app.py 改善提案

## 1. ユーザー体験 (UX)

| 項目 | 現状 | 提案 |
|------|------|------|
| **初回表示** | 「シミュレーション実行」を押すまで何も表示されない | 初期表示でデフォルト設定で1回だけ自動実行するか、サンプル結果を表示する |
| **再計算** | 設定を変えるたびに必ずボタンを押す必要がある | オプションで「設定変更時に自動再計算」を選べるようにする |
| **終了日** | 開始日のみで終了日は「今日」固定 | サイドバーに「終了日」を追加し、バックテスト期間を自由に指定できるようにする |
| **銘柄の説明** | 4銘柄の日本語名がコード内にハードコード | プリセット（例：基本4資産・バランス型）を選べるようにするか、銘柄コードの横にヘルプ（ツールチップ）を表示する |

---

## 2. 計算の正確性・アルゴリズム

| 項目 | 現状 | 提案 |
|------|------|------|
| **最適ポートフォリオ** | ランダムシミュレーションの中から最大・最小を選んでいるだけ | `scipy.optimize` で**接点ポートフォリオ（最大シャープ）**と**最小分散ポートフォリオ**を数値最適化で正確に求める。シミュレーションは「分布の可視化」用に残す |
| **年率化** | 252倍（営業日）で統一 | コメントで「株価は営業日ベース」と明記。債券のみの場合は考慮の余地あり（現状のままでよい場合も多い） |
| **CML** | 接点のシャープで直線を引いている | 最適化で求めた接点を使うことで、CMLの傾きが理論と一致する |

---

## 3. パフォーマンス

| 項目 | 現状 | 提案 |
|------|------|------|
| **シミュレーション** | 最大1万ポートフォリオを Python の for ループで計算 | 行列演算でベクトル化する（重み行列 × 期待リターン、共分散の二次形式を一括計算）。必要なら `numba` でさらに高速化 |
| **キャッシュ** | 同じ設定でも毎回 yfinance と計算をやり直す | `@st.cache_data` で「銘柄リスト＋開始日＋終了日」をキーに価格データ取得をキャッシュ。計算結果も `st.session_state` に保持し、設定未変更なら再計算しない |

---

## 4. エラー処理・堅牢性

| 項目 | 現状 | 提案 |
|------|------|------|
| **例外** | `except Exception as e` で一括捕捉 | `yfinance` のネットワークエラー、`ValueError`（銘柄不正）など、種類ごとにメッセージを分ける。必要なら `st.exception` でスタックトレースを折りたたみ表示 |
| **データ不足** | データが空・少ない場合にメッセージ表示 | 一部銘柄だけ取得失敗した場合は「取得できた銘柄のみで続行しますか？」と確認するか、取得できた銘柄リストを表示する |
| **価格データの列** | `Adj Close` の有無で分岐 | `Open/High/Low/Close/Adj Close` のうち存在する列を優先して選ぶ処理にすると、APIの仕様変更に強い |

---

## 5. コード構成・保守性

| 項目 | 現状 | 提案 |
|------|------|------|
| **単一ファイル** | すべて streamlit_app.py に記述 | データ取得・リターン計算・最適化・プロットを関数化し、必要なら `data_loader.py`, `portfolio.py`, `viz.py` などに分割する |
| **定数** | 252, 20, 1.5 などがマジックナンバー | ファイル上部で `ANNUALIZE_TRADING_DAYS = 252`, `MIN_OBSERVATIONS = 20` などとして名前付き定数にする |
| **日本語ラベル** | `ticker_map` がメイン処理の途中に定義 | 設定ブロックや定数としてファイル上部にまとめ、銘柄を増やしやすくする |

---

## 6. 機能追加の候補

- **結果のエクスポート**: 効率的フロンティアの座標、最適ポートフォリオのウェイト、個別銘柄統計を CSV/Excel でダウンロード
- **時系列チャート**: 選択したポートフォリオ（例：接点・最小分散）の組入比率で過去リターンを再計算し、累積リターンやドローダウンを表示
- **リスク指標の追加**: 最大ドローダウン、ソートinoレシオ、VaR などをオプションで表示
- **複数無リスク金利**: 金利シナリオを複数設定し、CMLや接点がどう変わるかを比較

---

## 7. 依存関係 (requirements.txt)

| 項目 | 現状 | 提案 |
|------|------|------|
| **未使用パッケージ** | `altair`, `matplotlib` が記載されているがコード内で未使用 | 使う予定がなければ削除。可視化を増やすなら Plotly に統一するか、意図して使い分ける |
| **バージョン** | yfinance, numpy, pandas, plotly はバージョン未指定 | 再現性のため主要パッケージは `yfinance>=0.2.x` のように下限を指定することを推奨 |
| **最適化** | scipy を使用する場合 | 提案「2. 計算の正確性」を採用するなら `scipy` を requirements.txt に追加する |

---

## 実装の優先度の目安

1. **高**: 初回表示の改善（自動1回実行 or サンプル表示）、結果のキャッシュ、エラーメッセージの明確化  
2. **中**: 終了日の追加、scipy による最適ポートフォリオの正確な計算、シミュレーションのベクトル化  
3. **低**: コードのモジュール分割、CSV エクスポート、追加リスク指標  

必要に応じて、上記のどれから実装するか決めるとよいです。

---

## 実装済み vs 残タスク（要約）

| カテゴリ | 項目 | 状態 |
|----------|------|------|
| UX | 初回表示（自動1回実行） | ✅ 済 |
| UX | 結果のキャッシュ（cache_data + session_state） | ✅ 済 |
| UX | エラーメッセージの明確化 | ✅ 済 |
| UX | プリセット・銘柄表示名（基本4資産 / 資産市場全体 / カスタム） | ✅ 済 |
| UX | 設定変更時の自動再計算オプション | 未 |
| UX | 終了日の追加 | 未 |
| 計算 | scipy で接点・最小分散を正確に最適化 | 未 |
| 計算 | 年率化のコメント明記 | 未 |
| 性能 | シミュレーションのベクトル化 | 未 |
| エラー | 一部銘柄のみ取得失敗時の続行確認 | 未 |
| エラー | 価格列のフォールバック（Close 等） | 未 |
| 構成 | 定数化（252, 20 等） | 未 |
| 構成 | モジュール分割 | 未 |
| 機能 | CSV/Excel エクスポート | 未 |
| 機能 | 時系列チャート（累積・ドローダウン） | 未 |
| 機能 | リスク指標追加（ソルティノ、VaR 等） | 未 |
| 機能 | 複数無リスク金利の比較 | 未 |
| 依存 | 未使用パッケージ整理・バージョン指定・scipy 追加 | 未 |
